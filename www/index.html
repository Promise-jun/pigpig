<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>pigpig</title>
    <!-- Bootstrap core CSS -->
    <link href="./css/bootstrap.min.css" rel="stylesheet">
    <!-- Custom styles for this template -->
    <!-- 引入index.css -->
    <link rel="stylesheet" type="text/css" href="./css/index.css">
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>

  <body role="document" ng-app="health">
      <ui-view></ui-view>
    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="./js/jquery-1.11.3.js"></script>
    <script src="./js/bootstrap.min.js"></script>
    <script type="text/javascript" src="./js/index.js"></script>
    <script type="text/javascript" src="./js/angular.js"></script>
    <script type="text/javascript" src="./js/angular-ui-router.js"></script>
    <script type="text/javascript">
      var healthApp=angular.module('health',['ui.router'])
      .run(function($rootScope, $state, $stateParams) {
        $rootScope.$on("$stateChangeSuccess", function(event, toState, toParams, fromState, fromParams) {
            // to be used for back button //won't work when page is reloaded.
            $rootScope.previousState_name = fromState.name; //记录前一个路由的名称
            $rootScope.previousState_params = fromParams; //记录前一个路由的参数
        });
        //back button function called from back button's ng-click="back()"
        $rootScope.back = function(obj) {
          //如果前一个路由的名称长度为0，就意味着没有前一个路由操作，我们就没有返回的路径
          if($rootScope.previousState_name.trim().length != 0){
            $state.go($rootScope.previousState_name, $rootScope.previousState_params);
            
          }else{
            // alert('没有可返回的页面!');
            $('#'+obj).popover('show');

          }
        };
      })
      .config(function($stateProvider,$urlRouterProvider,$urlMatcherFactoryProvider){
          $urlRouterProvider.otherwise('/navbar/home'); //默认页
          $urlMatcherFactoryProvider.caseInsensitive(true); //忽略大小写(不敏感匹配)
          $stateProvider
          .state("navbar",{ //公共父页
            url:'/navbar',
            templateUrl:'./template/navbar.html',
            controller:'navbarController'
          })
          .state("navbar.home",{ //主页
            url:'/home',
            templateUrl:'./template/home.html',
            controller:'homeController'
          })
          .state("navbar.issueList",{ //问题列表页
            url:'/issueList/:id/:page',
            templateUrl:'./template/issueList.html',
            controller:'issueListController'
          })
          .state("navbar.issueDetail",{ //问题详情页
            url:'/issueDetail/:id',
            templateUrl:'./template/issueDetail.html',
            controller:'issueDetailController'
          })
      })
      //公共父页控制器
      .controller('navbarController',function($scope,$http){ 
          $http({
            url:'http://localhost/issue-assort.php',
            method:'get'
          }).then(function(res){
            $scope.issueCategories=res.data.tngou;
          })
      })
      //主页控制器
      .controller('homeController',function($scope){
          var num=0;
          var bstop=true;  //开关
          $('.btnList li').on('mouseover',function(){
            num=$(this).index();   //把当前索引给num
            tab();
          })
          // 左边箭头单击事件
          $('.rightBtn').on('click',function(){
            if (bstop) {
              num++;
              if (num==6) {
                $('.btnList li').first().addClass('active').siblings('li').removeClass('active');
              }
              tab();
            }
            bstop=false;
          })
          // 右边箭头单击事件
          $('.leftBtn').on('click',function(){
            if (bstop) {
              num--;
              tab();
            }
            bstop=false;
          })
          $('.leftBtn').hide();
          $('.rightBtn').hide();
          // 定时器自动轮播
          var timer=setInterval(function(){
            $('.rightBtn').click();
          },3000)
          // 鼠标移入移出效果
          $('.carousel').hover(
            function(){
              $('.leftBtn').show(400);
              $('.rightBtn').show(400);
              clearInterval(timer);
            },
            function(){
              $('.leftBtn').hide(400);
              $('.rightBtn').hide(400);
              timer=setInterval(function(){
                $('.rightBtn').click();
              },3000)
            }
          )
          // 封装的轮播函数
          function tab(){
            $('.btnList li').eq(num).addClass('active').siblings('li').removeClass('active');
            $('.picList').animate({left:(-100*(num+1))+'%'},400,function(){
              if (num==6) { //当图片到最后一张的时候，强行定位回初始状态
                $('.picList').css('left','-100%');
                num=0;
              }
              if (num==-1) { //当图片到第一张的时候，强行定位回最后一张
                $('.picList').css('left',(-100*6)+'%');
                num=5;
              }
              bstop=true;
            })
          }
      })
      //问题列表页控制器
      .controller('issueListController',function($scope,$http,$stateParams){ 
          $http({
            url:'http://localhost/issue-list.php',
            method:'get',
            params:{
              id:$stateParams.id,
              page:$stateParams.page
            }
          }).then(function(res){
            $scope.issueList=res.data.tngou;
            
            var pageCountList=[]; //创建数组保存页码
            var rows=12;          //每页显示的个数
            var sumPage=Math.ceil(res.data.total/rows); //求出总的页数
            for(var i=1; i<=sumPage; i++){
              pageCountList.push(i);
            }
            $scope.id=$stateParams.id;
            $scope.pageCountList=pageCountList;

            $scope.begin=0;
            //showPageAdd--->点击向上滚动页码
            $scope.showPageAdd=function(begin){
              if ($scope.begin>=sumPage-10) {
                return false;
              }
              $scope.begin++; 
            }
            //showPageDown--->点击向下滚动页码
            $scope.showPageDown=function(begin){
              if ($scope.begin<=0) {
                return false;
              }
              $scope.begin--;
            }
          })
      })
      //问题详情页控制器
      .controller('issueDetailController',function($scope,$http,$stateParams,$sce){ 
         $http({
            url:'http://localhost/issue-detail.php',
            method:'get',
            params:{
              id:$stateParams.id
            }
         }).then(function(res){
            $scope.issueDetail=res.data;
            $scope.issueDetailMessage=$sce.trustAsHtml($scope.issueDetail.message)
         })
      })
      function addActive(vm){
        $(vm).addClass('active');
      }
    </script>
  </body>
</html>

